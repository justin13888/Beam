# ----------------------------------------------------
# Stage 1: Build FFmpeg 8.0 from source
# ----------------------------------------------------
FROM docker.io/debian:trixie-slim AS ffmpeg-builder

# Install all build dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    build-essential pkg-config yasm nasm wget ca-certificates \
    libx264-dev libx265-dev libvpx-dev \
    libopus-dev libass-dev libfreetype-dev libfontconfig-dev \
    libfribidi-dev libogg-dev libssl-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /tmp/ffmpeg

RUN wget -q https://ffmpeg.org/releases/ffmpeg-8.0.tar.xz && \
    tar xf ffmpeg-8.0.tar.xz && \
    cd ffmpeg-8.0 && \
    ./configure \
    --prefix=/opt/ffmpeg \
    --disable-debug \
    --disable-doc \
    --disable-ffplay \
    --enable-shared \
    --disable-static \
    --enable-gpl \
    --enable-version3 \
    --enable-fontconfig \
    --enable-libass \
    --enable-libfontconfig \
    --enable-libfreetype \
    --enable-libfribidi \
    --enable-libopus \
    --enable-libvpx \
    --enable-libx264 \
    --enable-libx265 \
    --enable-openssl \
    --enable-small \
    --extra-cflags="-I/opt/ffmpeg/include" \
    --extra-ldflags="-L/opt/ffmpeg/lib" \
    --extra-libs=-lpthread \
    --extra-libs=-lm && \
    make -j$(nproc) && \
    make install

# ----------------------------------------------------
# Chef: Setup chef image
# ----------------------------------------------------
FROM docker.io/rust:1.91-slim-trixie AS chef
RUN cargo install cargo-chef --locked
WORKDIR /app

# ----------------------------------------------------
# Planner: Create dependency recipe
# ----------------------------------------------------
FROM chef AS planner
COPY . .
RUN cargo chef prepare --recipe-path recipe.json

# ----------------------------------------------------
# Schema: Generate GraphQL schema from Rust types
# ----------------------------------------------------
FROM chef AS schema-builder

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    clang libclang-dev pkg-config \
    protobuf-compiler \
    libx264-dev libx265-dev libvpx-dev \
    libopus-dev libass-dev libfreetype-dev libfontconfig-dev \
    libfribidi-dev libogg-dev libssl-dev \
    && rm -rf /var/lib/apt/lists/*

COPY --from=ffmpeg-builder /opt/ffmpeg /opt/ffmpeg

ENV PKG_CONFIG_PATH=/opt/ffmpeg/lib/pkgconfig
ENV LD_LIBRARY_PATH=/opt/ffmpeg/lib:/usr/lib/aarch64-linux-gnu:/usr/lib/x86_64-linux-gnu
ENV PATH=/opt/ffmpeg/bin:$PATH

# Cook dependencies for the schema export binary
COPY --from=planner /app/recipe.json recipe.json
RUN cargo chef cook --recipe-path recipe.json --bin export_schema

COPY . .
RUN cargo build --bin export_schema
RUN cd beam-stream && ../target/debug/export_schema

# ----------------------------------------------------
# Build: Build the application using Bun
# ----------------------------------------------------
FROM docker.io/oven/bun:1.3-debian AS builder

# Accept build arguments for environment variables
ARG C_APP_TITLE=Beam
ARG C_STREAM_SERVER_URL=http://localhost:8000

WORKDIR /app

# Copy workspace root package files and all workspace member package.json files for dependency install
COPY package.json bun.lock ./
COPY beam-web/package.json ./beam-web/
COPY beam-docs/package.json ./beam-docs/

# Install dependencies from workspace root
RUN bun install --frozen-lockfile

# Copy beam-web source and the generated schema from schema-builder
COPY beam-web ./beam-web
COPY --from=schema-builder /app/beam-stream/schema.graphql ./beam-stream/schema.graphql

# Generate TypeScript types from the schema
WORKDIR /app/beam-web
RUN bun run codegen

# Build the application with environment variables
ENV C_APP_TITLE=${C_APP_TITLE}
ENV C_STREAM_SERVER_URL=${C_STREAM_SERVER_URL}
RUN bun run build

# ----------------------------------------------------
# Stage 2: Serve statically-built web app with HTTP (caching handled externally)
# ----------------------------------------------------
FROM docker.io/caddy:2-alpine

# Copy built assets from builder stage (bun run build outputs to /app/beam-web/dist)
COPY --from=builder /app/beam-web/dist /srv

# Copy Caddyfile
COPY <<EOF /etc/caddy/Caddyfile
{
    auto_https off
    admin off
}

:80 {
    root * /srv
    encode gzip zstd
    file_server
    try_files {path} /index.html

    header {
        # Security headers
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
    }

    # Cache static assets
    @static {
        path *.js *.css *.woff *.woff2 *.ttf *.eot *.ico *.png *.jpg *.jpeg *.gif *.svg *.webp
    }
    header @static Cache-Control "public, max-age=31536000, immutable"
}
EOF

EXPOSE 80
